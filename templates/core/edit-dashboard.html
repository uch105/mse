{% extends 'core/base.html' %}
{% load static %}

{% block title %}
Edit Dashboard - {{ profile.full_name }} |  MatSci Hub
{% endblock %}

{% block meta_links %}
{% endblock %}

{% block head_scripts %}
    <style>
        /* Edit Dashboard Specific Styles */
        .edit-dashboard-container {
            flex: 1;
            padding: 120px 0 50px;
        }

        /* Edit Form Layout */
        .edit-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }

        @media (max-width: 968px) {
            .edit-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Profile Preview Sidebar */
        .profile-preview-sidebar {
            position: sticky;
            top: 140px;
            height: fit-content;
        }

        .preview-card {
            text-align: center;
            padding: 30px;
        }

        .profile-picture-container {
            position: relative;
            width: 150px;
            margin: 0 auto 20px;
        }

        .profile-picture {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            border: 3px solid var(--secondary);
            margin-bottom: 10px;
        }

        .profile-picture img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .change-photo-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .change-photo-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .preview-name {
            font-size: 1.4rem;
            margin-bottom: 5px;
            color: var(--light);
        }

        .preview-level {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .preview-info {
            text-align: left;
            margin-top: 20px;
        }

        .preview-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .preview-item i {
            color: var(--secondary);
            width: 20px;
            margin-top: 5px;
        }

        /* Edit Form Main Content */
        .edit-form-main {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* Form Sections */
        .form-section {
            margin-bottom: 10px;
        }

        .form-section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--light);
            padding-bottom: 10px;
            border-bottom: 2px solid var(--card-border);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Form Styles */
        .form-card {
            text-align: left;
            padding: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--light);
        }

        .form-label .required {
            color: var(--accent);
        }

        .form-control {
            width: 100%;
            padding: 15px 20px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--light);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(0, 196, 204, 0.2);
        }

        .form-control::placeholder {
            color: var(--gray);
        }

        .form-hint {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* Tags Input */
        .tags-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 15px 20px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-height: 60px;
            align-items: center;
        }

        .tag {
            background: rgba(255, 255, 255, 0.15);
            color: var(--light);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag-remove {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            padding: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .tag-remove:hover {
            background: rgba(255, 64, 129, 0.2);
        }

        .tags-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--light);
            font-size: 0.9rem;
            min-width: 100px;
            outline: none;
        }

        .tags-input::placeholder {
            color: var(--gray);
        }

        /* File Upload */
        .file-upload-container {
            position: relative;
        }

        .file-upload-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px 20px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            gap: 10px;
        }

        .file-upload-label:hover {
            border-color: var(--secondary);
            background: rgba(255, 255, 255, 0.08);
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-full {
            flex: 1;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-save {
            background: linear-gradient(135deg, var(--success), #00a344);
        }

        .btn-save:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 200, 83, 0.3);
        }

        /* Success Message */
        .success-message {
            display: none;
            text-align: center;
            padding: 60px 40px;
            background: rgba(0, 200, 83, 0.1);
            border: 1px solid var(--success);
            border-radius: 15px;
        }

        .success-icon {
            font-size: 4rem;
            color: var(--success);
            margin-bottom: 20px;
        }

        .success-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: var(--light);
        }

        .success-text {
            color: var(--gray);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* Responsive Design */
        @media (max-width: 768px) {            
            .edit-dashboard-container {
                padding: 100px 0 30px;
            }
            
            .edit-title {
                font-size: 1.8rem;
            }

            .profile-preview-sidebar {
                position: static;
                top: auto;
                margin-bottom: 30px;
            }
            
            .form-actions {
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            
            .profile-picture {
                width: 120px;
                height: 120px;
                font-size: 2.5rem;
            }
        }

        @media (max-width: 576px) {
            .edit-title {
                font-size: 1.5rem;
            }
            
            .form-card {
                padding: 20px;
            }
            
            .form-section-title {
                font-size: 1.2rem;
            }
        }

        /* Responsive Design */


    </style>
{% endblock %}

{% block body %}
    <!-- Edit Dashboard Content -->
    <main class="edit-dashboard-container">
        <div class="container">

            <!-- Edit Layout -->
            <div class="edit-layout">
                <!-- Profile Preview Sidebar -->
                <aside class="profile-preview-sidebar">
                    <div class="card preview-card">
                        <div class="profile-picture-container">
                            <div class="profile-picture">
                                {% if profile.profile_picture %}
                                    <img src="{{ profile.profile_picture.url }}" alt="{{ profile.full_name }}">
                                {% else %}
                                <i class="fas fa-user"></i>
                                {% endif %}
                            </div>
                            <button class="change-photo-btn">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                        <h2 class="preview-name" id="previewName">{{ profile.full_name }}</h2>
                        <div class="preview-level">{{ profile.level }}</div>
                        
                        <div class="preview-info">
                            <div class="preview-item">
                                <i class="fas fa-envelope"></i>
                                <span id="previewEmail">{{ user.email }}</span>
                            </div>
                            <div class="preview-item">
                                <i class="fas fa-university"></i>
                                <span id="previewInstitution">{{ profile.institution }}</span>
                            </div>
                            <div class="preview-item">
                                <i class="fas fa-graduation-cap"></i>
                                <span id="previewDegree">{{ profile.degree }}</span>
                            </div>
                            <div class="preview-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span id="previewCountry">{{ profile.country }}</span>
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- Edit Form Main Content -->
                <div class="edit-form-main">
                    <form id="editProfileForm">
                        {% csrf_token %}
                        <!-- Personal Information Section -->
                        <section class="form-section">
                            <h3 class="form-section-title">Personal Information</h3>
                            <div class="card form-card">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="firstName" class="form-label">
                                            First Name <span class="required">*</span>
                                        </label>
                                        <input 
                                            type="text" 
                                            id="firstName" 
                                            class="form-control" 
                                            value="{{ user.first_name }}"
                                            name="firstName"
                                            required
                                        >
                                    </div>

                                    <div class="form-group">
                                        <label for="lastName" class="form-label">
                                            Last Name <span class="required">*</span>
                                        </label>
                                        <input 
                                            type="text" 
                                            id="lastName" 
                                            class="form-control" 
                                            value="{{ user.last_name }}"
                                            name="lastName"
                                            required
                                        >
                                    </div>

                                    <div class="form-group">
                                        <label for="country" class="form-label">
                                            Country
                                        </label>
                                        <input 
                                            type="text" 
                                            id="country" 
                                            class="form-control" 
                                            value="{{ profile.country }}"
                                            name="country"
                                            placeholder="Enter your country"
                                        >
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Professional Information Section -->
                        <section class="form-section">
                            <h3 class="form-section-title">Professional Information</h3>
                            <div class="card form-card">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="institution" class="form-label">
                                            Institution/Organization
                                        </label>
                                        <input 
                                            type="text" 
                                            id="institution" 
                                            class="form-control" 
                                            value="{{ profile.institution }}"
                                            name="institution"
                                            placeholder="Enter your institution"
                                        >
                                    </div>

                                    <div class="form-group">
                                        <label for="degree" class="form-label">
                                            Highest Degree
                                        </label>
                                        <input 
                                            type="text" 
                                            id="degree" 
                                            class="form-control" 
                                            value="{{ profile.degree }}"
                                            name="degree"
                                            placeholder="Enter your degree"
                                        >
                                    </div>

                                    <div class="form-group">
                                        <label for="specialization" class="form-label">
                                            Specialization
                                        </label>
                                        <input 
                                            type="text" 
                                            id="specialization" 
                                            class="form-control" 
                                            value="{{ profile.specialization }}"
                                            name="specialization"
                                            placeholder="Enter your specialization"
                                        >
                                    </div>

                                    <div class="form-group">
                                        <label for="linkedin" class="form-label">
                                            LinkedIn Profile
                                        </label>
                                        <input 
                                            type="url" 
                                            id="linkedin" 
                                            class="form-control" 
                                            value="{{ profile.linkedin }}"
                                            name="linkedin"
                                            placeholder="https://linkedin.com/in/yourprofile"
                                        >
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="bio" class="form-label">
                                        Bio/Introduction
                                    </label>
                                    <textarea 
                                        id="bio" 
                                        class="form-control" 
                                        rows="4"
                                        name="bio"
                                        placeholder="Tell us about your research background and interests..."
                                    >{{ profile.bio }}</textarea>
                                </div>
                            </div>
                        </section>

                        <!-- Research Interests Section -->
                        <section class="form-section">
                            <h3 class="form-section-title">Research Interests</h3>
                            <div class="card form-card">
                                <div class="form-group">
                                    <label class="form-label">
                                        Research Interests
                                    </label>
                                    <div class="tags-input-container" id="interestsContainer">
                                        <!-- Tags will be added here by JavaScript -->
                                        <input 
                                            type="text" 
                                            class="tags-input" 
                                            id="interestsInput"
                                            placeholder="Type an interest and press Enter (e.g., Nanomaterials, Thermodynamics)"
                                        >
                                    </div>
                                    <div class="form-hint">Separate interests with commas or press Enter after each interest</div>
                                </div>
                            </div>
                        </section>

                        <!-- Skills Section -->
                        <section class="form-section">
                            <h3 class="form-section-title">Skills & Expertise</h3>
                            <div class="card form-card">
                                <div class="form-group">
                                    <label class="form-label">
                                        Skills & Technical Expertise
                                    </label>
                                    <div class="tags-input-container" id="skillsContainer">
                                        <!-- Tags will be added here by JavaScript -->
                                        <input 
                                            type="text" 
                                            class="tags-input" 
                                            id="skillsInput"
                                            placeholder="Type a skill and press Enter (e.g., Python, MATLAB, SEM)"
                                        >
                                    </div>
                                    <div class="form-hint">Separate skills with commas or press Enter after each skill</div>
                                </div>
                            </div>
                        </section>

                        <!-- Profile Picture Section -->
                        <section class="form-section">
                            <h3 class="form-section-title">Profile Picture</h3>
                            <div class="card form-card">
                                <div class="form-group">
                                    <label class="form-label">
                                        Update Profile Picture
                                    </label>
                                    <div class="file-upload-container">
                                        <input 
                                            type="file" 
                                            id="profilePicture" 
                                            class="file-upload-input"
                                            name="profilePicture" 
                                            accept="image/*"
                                        >
                                        <label for="profilePicture" class="file-upload-label">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <span>Click to upload new profile picture</span>
                                        </label>
                                    </div>
                                    <div class="form-hint">Recommended: Square image, JPG or PNG, max 5MB</div>
                                </div>
                            </div>
                        </section>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <button type="button" class="btn btn-cancel btn-full" onclick="window.history.back()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-save btn-full">
                                Save Changes <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </form>

                    <div id="hiddenInterestList" style="display: none;">
                            {{ profile.interest_list }}
                    </div>
                    <div id="hiddenSkillList" style="display: none;">
                            {{ profile.skill_list }}
                    </div>

                    <!-- Success Message -->
                    <div id="successMessage" class="success-message">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3 class="success-title">Profile Updated Successfully!</h3>
                        <p class="success-text">
                            Your profile information has been saved. The changes will be reflected across the platform immediately.
                        </p>
                        <div class="form-actions">
                            <a href="{% url 'dashboard' %}" class="btn btn-primary btn-full">
                                Return to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock %}

{% block body_scripts %}
    <script>
        // Mobile menu functionality
        document.addEventListener('DOMContentLoaded', function() {
            // csrf token for AJAX requests if needed
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            // Initialize tags for research interests
            const interestsContainer = document.getElementById('interestsContainer');
            const interestsInput = document.getElementById('interestsInput');
            const initialInterests = document.getElementById('hiddenInterestList').textContent.trim().replace(/['\[\]]/g, '').split(',').map(item => item.trim()).filter(item => item);
            
            // Initialize tags for skills
            const skillsContainer = document.getElementById('skillsContainer');
            const skillsInput = document.getElementById('skillsInput');
            const initialSkills = document.getElementById('hiddenSkillList').innerText.trim().replace(/['\[\]]/g, '').split(',').map(item => item.trim()).filter(item => item);

            // Function to create a tag
            function createTag(text, container) {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${text}
                    <button type="button" class="tag-remove">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                const removeBtn = tag.querySelector('.tag-remove');
                removeBtn.addEventListener('click', () => {
                    container.removeChild(tag);
                });
                
                return tag;
            }

            // Function to initialize tags
            function initializeTags(initialTags, container, input) {
                initialTags.forEach(tagText => {
                    const tag = createTag(tagText, container);
                    container.insertBefore(tag, input);
                });
            }

            // Initialize both tag containers
            initializeTags(initialInterests, interestsContainer, interestsInput);
            initializeTags(initialSkills, skillsContainer, skillsInput);

            // Function to add tag on Enter or comma
            function setupTagInput(input, container) {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ',') {
                        e.preventDefault();
                        const tagText = input.value.trim();
                        if (tagText) {
                            const tag = createTag(tagText, container);
                            container.insertBefore(tag, input);
                            input.value = '';
                        }
                    }
                });

                // Also allow pasting comma-separated values
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pastedText = e.clipboardData.getData('text');
                    const tags = pastedText.split(',').map(tag => tag.trim()).filter(tag => tag);
                    tags.forEach(tagText => {
                        const tag = createTag(tagText, container);
                        container.insertBefore(tag, input);
                    });
                });
            }

            // Setup both tag inputs
            setupTagInput(interestsInput, interestsContainer);
            setupTagInput(skillsInput, skillsContainer);

            // Real-time preview updates
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const degreeInput = document.getElementById('degree');
            const institutionInput = document.getElementById('institution');
            const countryInput = document.getElementById('country');
            
            const previewName = document.getElementById('previewName');
            const previewDegree = document.getElementById('previewDegree');
            const previewInstitution = document.getElementById('previewInstitution');
            const previewCountry = document.getElementById('previewCountry');

            // Update preview in real-time
            function updatePreview() {
                previewName.textContent = `${firstNameInput.value} ${lastNameInput.value}`;
                previewDegree.textContent = degreeInput.value || 'No degree provided';
                previewInstitution.textContent = institutionInput.value || 'No institution provided';
                previewCountry.textContent = countryInput.value || 'No country provided';
            }

            // Add event listeners for real-time updates
            [firstNameInput, lastNameInput, degreeInput, institutionInput, countryInput].forEach(input => {
                input.addEventListener('input', updatePreview);
            });

            // Profile picture upload
            const profilePictureInput = document.getElementById('profilePicture');
            const profilePicture = document.querySelector('.profile-picture');
            const changePhotoBtn = document.querySelector('.change-photo-btn');

            profilePictureInput.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    
                    // Validate file type
                    if (!file.type.match('image.*')) {
                        alert('Please select an image file (JPG, PNG, etc.)');
                        return;
                    }
                    
                    // Validate file size (5MB max)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size must be less than 5MB');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        profilePicture.innerHTML = '';
                        profilePicture.style.backgroundImage = `url(${e.target.result})`;
                        profilePicture.style.backgroundSize = 'cover';
                        profilePicture.style.backgroundPosition = 'center';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Change photo button also triggers file input
            changePhotoBtn.addEventListener('click', function() {
                profilePictureInput.click();
            });

            // Form submission
            const editProfileForm = document.getElementById('editProfileForm');
            const successMessage = document.getElementById('successMessage');

            editProfileForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Collect all tags
                const interestsTags = Array.from(interestsContainer.querySelectorAll('.tag'))
                    .map(tag => tag.textContent.trim().replace('×', '').trim());
                
                const skillsTags = Array.from(skillsContainer.querySelectorAll('.tag'))
                    .map(tag => tag.textContent.trim().replace('×', '').trim());

                // Basic validation
                const firstName = firstNameInput.value.trim();
                const lastName = lastNameInput.value.trim();
                
                if (!firstName || !lastName) {
                    alert('Please fill in all required fields');
                    return;
                }

                // Simulate form submission
                const submitBtn = editProfileForm.querySelector('.btn-save');
                const originalText = submitBtn.innerHTML;
                
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                submitBtn.disabled = true;

                // submit form to backend via AJAX or fetch here
                // Collect form data
                const formData = new FormData(editProfileForm);
                // Add tags manually if needed
                formData.append('interests', interestsTags.join(','));
                formData.append('skills', skillsTags.join(','));

                fetch("{% url 'edit-dashboard' %}", {
                    method: "POST",
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Handle success
                    editProfileForm.style.display = 'none';
                    successMessage.style.display = 'block';
                    successMessage.scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    alert('Error saving profile!');
                });
            });

            // Add animation to form elements
            const formElements = document.querySelectorAll('.form-section');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, { threshold: 0.1 });
            
            formElements.forEach(element => {
                element.style.opacity = '0';
                element.style.transform = 'translateY(20px)';
                element.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(element);
            });
        });
    </script>
{% endblock %}